---
authors:
  - karlipe
date: 2021-04-06
categories:
    - SRE/DevOps
tags:
    - ansible
---


# **#HowToSRE - Ansible-Parte03**

<figure markdown="span">
  ![](../old-imgs/how-to-sre-ansible-03/TN_HowToSRE_Ansible03.png)
</figure>


E ae galera beleza? Nesse post iremos falar um pouco sobre o que s√£o Facts e como podemos utilizar as informa√ß√µes contidas neles. Falaremos tamb√©m sobre Ansible Vault, qual sua utilidade, exemplos e como utilizar na pr√°tica, al√©m de claro ter como praticar com alguns LABs.

Aproveitem!! ü§ôü§ô

<!-- more -->

## Facts
### Como obter informa√ß√µes
**Facts** ou Fatos s√£o informa√ß√µes do servidor destino que podem ser obtidas utilizando ansible que retornam utilizando vari√°veis nativas do ansible. Exemplo:

```shell
$ ansible host1.example.com -m setup 
host1.example.com | SUCCESS => {
    "ansible_facts": {
        "ansible_all_ipv4_addresses": [
            "172.31.2.51"
        ], 
        "ansible_all_ipv6_addresses": [
            "fe80::5cd8:2eaf:3adf:c23a"
        ], 
        "ansible_apparmor": {
            "status": "disabled"
        }, 
        "ansible_architecture": "x86_64", 
        "ansible_bios_date": "12/12/2018", 
        "ansible_bios_version": "6.00", 
        ....
        ....
```

Existe a possibilidade de ainda utilizando o modo ad-hoc mas filtrar algumas informa√ß√µes caso julgue importante. Exemplo:
```shell
$ ansible host2.example.com -m setup -a "filter=ansible_kernel"
host2.example.com | SUCCESS => {
    "ansible_facts": {
        "ansible_kernel": "3.10.0-1160.21.1.el7.x86_64", 
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false
}
```
<br/><br/>
### Desabilitando Gathering Facts
Caso voc√™ n√£o tenha notado nos v√≠deos dos repasses anteriores, sempre ao in√≠cio de cada execu√ß√£o dos playbooks, este fun√ß√£o √© realizada a fim de colher informa√ß√µes que talvez sejam necess√°rias para a execu√ß√£o correta do Playbook.

![Gathering Facts1](../old-imgs/how-to-sre-ansible-03/ansible03-01.png)

Uma **boa pr√°tica** importante, caso voc√™ n√£o a necessidade de usar essas informa√ß√µes e/ou caso voc√™ tenha um grande grupo de m√°quinas para executar, o que pode causar uma certa lentid√£o no ambiente, o indicado √© desabilitar esta op√ß√£o dentro do playbook, da seguinte forma:

```yaml
$ vim motd.yml
---
- name: Alterarando arquivos
  hosts: host1.example.com
  gather_facts: no
  ...
```

![Gathering Facts2](../old-imgs/how-to-sre-ansible-03/ansible03-02.png)

<br/><br/>

### Custom Facts
Administradores podem criar Facts Personalizados para seus hosts gerenciados, estas informa√ß√µes ficar√£o gravads localmente em cada host. Por padr√£o os Facts personalizados s√£o salvos em arquivos "**.fact**" e salvos no diret√≥rio "**/etc/ansible/facts.d/**". Estes arquivs√£o s√£o escritos no formato INI ou tamb√©m podem ser escritos no formato json. Segue abaixo um exemplo de um arquivo escrito no formato INI. Onde assim como no invent√°rio o grupo √© definido pelo nome entre colchetes "**[...]**" e logo abaixo a vari√°vel com a defini√ß√£o de valor.

```shell
$ cat /etc/ansible/fact.d/cringerlabs.fact
[environment]
deploy = prod

[general]
package = nginx
```

E assim como os Fatos nativos, estes tamb√©m podem ser consumidos pelo bin√°rio de forma ad-hoc, filtrando pelo par√¢metro "**ansible_local**".
```shell
$ ansible host2.example.com -m setup -a "filter=ansible_local"
host2.example.com | SUCCESS => {
    "ansible_facts": {
        "ansible_local": {
            "cringerlabs": {
                "environment": {
                    "deploy": "prod"
                }
                "general": {
                    "package": "nginx"
                }
            }
        }
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false
}
```
<br/><br/>

### Utilizando Facts no Playbook 
Um exemplo b√°sico de utiliza√ß√£o de Facts no playbook √© conforme o exemplo abaixo. Utilizando a vari√°vel "**ansible_fqdn** podemos obter o fqdn de todos os hosts envolvidos.
{% raw %}
```yaml
---
- name: Utilizando Facts no Playbook01
  hosts: all
  tasks:
  - name: Exibindo FQDN
    debug:
      msg: >
        The package to install on {{ ansible_fqdn }}
```
{% endraw %}

![Facts_Playbook01](../old-imgs/how-to-sre-ansible-03/ansible03-03.png)

Outra forma igualmente elegante √© utilizar custom facts, com base no exemplo citado mais acima veja como √© simples de instalar um pacote.
{% raw %}
```yaml
---
- name: Utilizando Facts no Playbook02
  hosts: all
  tasks: 
  - name: Instalando Pacotes
    yum:
      name: "{{ ansible_facts.ansible_local.cringerlabs.general.package }}"
      state: latest
```
{% endraw %}

Como visto no exemplo, √© necess√°rio informar toda a cadeia de grupos at√© a vari√°vei que ser√° utilizada na task.

<br/><br/>

## Ansible Vault
**Ansible Vault** veio para dar um al√≠vio aos Administradores que necessitam passar informa√ß√µes sens√≠veis como senhas, api keys, chaves de acesso dentre outros, em seus playbooks e n√£o podem utilizar essa informa√ß√µes em texto plano. Ao instalar o pacote do ansible j√° √© poss√≠vel utiliza-lo para encriptar e decriptar qualquer arquivo que poder√° ser utilizado pelo ansible, incluindo: invent√°rio, arquivos de vari√°veis, playbooks.


### Manipu√ß√£o de arquivos encriptados
Segue abaixo uma exemplifica√ß√£o de como fazer:

**Cria√ß√£o de arquivo**
```shell
$ ansible-vault create arquivo.yml
New Vault password: 
Confirm New Vault password:
```

**Edi√ß√£o de arquivo encriptado**
```shell
$ ansible-vault edit arquivo.yml
Vault password: 
```

**Visualiza√ß√£o de arquivo encriptado**
```shell
$ ansible-vault view arquivo.yml
Vault password: 
```

**Encriptar arquivo ja existente**
```shell
$ ansible-vault encrypt arquivo.yml 
New Vault password: 
Confirm New Vault password:
```

**Decriptar arquivo ja existente**
```shell
$ ansible-vault decrypt arquivo.yml --output=arquivo-decriptado.yml
Vault password: 

$ ls
arquivo.yml
arquivo-decriptado.yml
```

**Recria√ß√£o de chave vault em arquivo encriptado**
```shell
$ ansible-vault create arquivo.yml
Vault password: #senha_atual
New Vault password: #senha_nova
Confirm New Vault password: #senha_nova
```

Caso voc√™ n√£o queria ter que digitar a senha √© possivel utilizar um arquivo contendo a senha para automatiza√ß√£o de scripts.

**Conteudo do arquivo**
```shell
$ cat senha-vault.txt
password
```

**Visualiza√ß√£o de conte√∫do utilizando arquivo de senha**
```shell
$ ansible-vault view --vault-password-file=senha-vault.txt arquivo.yml

```

**Edi√ß√£o de conte√∫do utilizando arquivo de senha**
```shell
$ ansible-vault edit --vault-password-file=senha-vault.txt arquivo.yml

```
<br/><br/>

### Utilizando Ansible Vault no Playbook

Supondo que o arquivo de variaveis do grupo esteja criptografado "**/group_vars/linux**", e voc√™ queira instalar um pacote "httpd" definido no mesmo. Ao tentar executar o Playbook voc√™ ir√° se depar√° com a seguinte tela.

![ansible-vault01](../old-imgs/how-to-sre-ansible-03/ansible03-04.png)

No erro informa que n√£o foi encontrado "vault secrets" para decriptar o Playbook. Em outras palavras √© necess√°rio que voc√™ passe o secret para o Playbook e h√° duas formas simples de fazer isso.

A primeira que √© solicitar que o Playbook pergunte a senha de forma, conforme abaixo:
```shell
$ ansible-playbook --vault-id @prompt package-vault.yml
Vault password:

PLAY [cada pacote no seu servidor] **********************************************************************

TASK [Gathering Facts] **********************************************************************************
ok: [host1.example.com]

TASK [instando o pacote httpd] **************************************************************************
changed: [host1.example.com]

PLAY RECAP **********************************************************************************************
host1.example.com          : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

```

A segunda forma √© utilizar arquivo de senha:
```shell
$ ansible-playbook --vault-password-file=senha-vault.txt package-vault.yml

PLAY [cada pacote no seu servidor] **********************************************************************

TASK [Gathering Facts] **********************************************************************************
ok: [host1.example.com]

TASK [instando o pacote httpd] **************************************************************************
changed: [host1.example.com]

PLAY RECAP **********************************************************************************************
host1.example.com          : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

```
<br/><br/>

### Dica do sucesso!

Para acelerar processos de envolvendo criptografia, √© aconselhado instalar o pacote **python-cryptography**. Por padr√£o o ansible utiliza fun√ß√µes do pacote "***python-crypto***", mas caso pretenda utilizar muitos arquivos encriptados o pacote **python-criptography** prover bibliotecas python que melhoram o desempenho.

```shell
$ yum install python-cryptography
```
<br/><br/>

## Exercicios

Todo post de repasse ser√° entregue um ou mais LABs baseados no conteudo repassado. Tente realizar o exercicio, caso tenha alguma dificuldade pode checar o arquivo no projeto do GitHUB, ou no link do v√≠deo.

### LAB04
- Criar um playbook direcionado ao servidor host1
  - Adicionar um custom fact no servidor
    - Crie um arquivo chamado "cringerlabs.fact" e adione os fatos abaixo
      - Group: webserver
        - Variable: role 
          - Value: webserver
      - Group: general
        - Variable: port
          - Value: 80
        - Variable: package
          - Value: nginx
    - Leve este arquivo ao servidor no diret√≥rio correto.

- Criar um segundo playbook para consumir os facts criados no playbook anterior gerando a frase abaixo:
    A fun√ß√£o do servidor host1 √© '***role***', 
    o pacote que instala o servi√ßo principal √© o '***package***',
    que √© executado na porta '***port***'/tcp."

### LAB05
- Criar Playbook direcionado ao host1.
  - Desinstalar o package httpd
    - Exiba o MacAddress com a seguinte frase
      - ‚ÄúO MacAddress do servidor host1 √© 'fact_contendo_macaddress'.‚Äù
    - Instale o package criado no Fact
    - Libere o servi√ßo criado no Fact
    - Inicie o servi√ßo criado no Fact
      - Use handlers
      - Force a inicializa√ß√£o do handler imediatamente
    - Check a vers√£o do nginx instalado
    - Exiba a vers√£o no nginx
    - Crie um arquivo de vari√°vel para o host1 utilizando o Vault 
      - Variavel: ‚ÄúCringerLabs SECRETS!!!‚Äù
      - Utilize o valor dessa vari√°vel como conte√∫do para o arquivo index.html com destino ‚Äú/usr/share/nginx/html/‚Äù
      - Check se o arquivo foi substituido



## Links do repasse

Divido entre labs e solutions, **labs** voc√™ ir√° encontrar os exercicios e os arquivos necess√°rios, quando existirem. E no diret√≥rio **solutions** o exericio resolvido, conforme v√≠deo. Segue como est√£o divido os diret√≥rios.

[**GITHUB - #HowToSRE Ansible**](https://github.com/karlipegomes/how_to_sre-ansible)

```bash
$ cd how_to_sre-ansible
$ tree .
.
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ labs
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ lab01
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ README.md
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ lab02
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ store.sql
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ lab03
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ block.txt
‚îî‚îÄ‚îÄ solutions
    ‚îú‚îÄ‚îÄ ansible.cfg
    ‚îú‚îÄ‚îÄ inventory
    ‚îú‚îÄ‚îÄ lab01
    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ add-user.yml
    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ lab01.yml
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ meuprimeiro-playbook.yml
    ‚îî‚îÄ‚îÄ lab02
        ‚îî‚îÄ‚îÄ store.sql
```

[**SLIDES**](https://drive.google.com/file/d/1L_t0sd7tXtGk_KjjmSFl9MUfCAMFkf12/view?usp=sharing)

<p align="center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/bSw9hCO0XqE" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>


### Agradecimentos.

Obrigado ao Joel por revisar o material e ao Joaquim por ser minha cobaia nesse repasse. <3

[Joel-Linkedin](https://www.linkedin.com/in/joelcostapinheiro/) - [Joel-Blog](https://joelpinheiro.com/) 

[Joaquim-Linkedin](https://www.linkedin.com/in/joaquimnetto/)